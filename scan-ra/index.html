<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        html, body {
          margin: 0;
          padding: 0;
          height: 100%;
          overflow: hidden;
          background: transparent;
        }
        a-scene {
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
        }
        .video-container {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1000;
        }
        .video-overlay {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          font-family: Arial, sans-serif;
          max-width: 300px;
        }
        .target-info {
          position: absolute;
          top: 20px;
          left: 20px;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 10px;
          border-radius: 5px;
          font-family: Arial, sans-serif;
          font-size: 14px;
        }
    </style>
  </head>
  <body>
    <a-scene
      mindar-image="imageTargetSrc: ./targets/targets(13).mind; maxTrack: 3; uiScanning: #ui-scanning; uiLoading: #ui-loading; filterMinCF: 0.0001; filterBeta: 0.05; missTolerance: 10; warmupTolerance: 5;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      embedded
    >
      <a-assets>
        <!-- Vídeo para Target 0 -->
        <video
          id="video1"
          src="assets/ayo_teste.mp4?v=2"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
          muted
        ></video>
        
        <!-- Vídeo para Target 1 (mesmo vídeo por enquanto) -->
        <video
          id="video2"
          src="assets/ayo_teste.mp4?v=2"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
          muted
        ></video>
        
        <!-- Vídeo para Target 2 (mesmo vídeo por enquanto) -->
        <video
          id="video3"
          src="assets/ayo_teste.mp4?v=2"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
          muted
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Target 0 - Primeiro vídeo -->
      <a-entity mindar-image-target="targetIndex: 0" id="target0">
        <a-plane
          id="videoPlane0"
          width="1"
          height="1"
          position="0 0.1 0.1"
          material="shader: flat; src: #video1"
          pose-smoother="positionFactor: 0.25; rotationFactor: 0.25; scaleFactor: 0.25"
          visible="false"
        ></a-plane>
      </a-entity>

      <!-- Target 1 - Segundo vídeo -->
      <a-entity mindar-image-target="targetIndex: 1" id="target1">
        <a-plane
          id="videoPlane1"
          width="1"
          height="1"
          position="0 0.1 0.1"
          material="shader: flat; src: #video2"
          pose-smoother="positionFactor: 0.25; rotationFactor: 0.25; scaleFactor: 0.25"
          visible="false"
        ></a-plane>
      </a-entity>

      <!-- Target 2 - Terceiro vídeo -->
      <a-entity mindar-image-target="targetIndex: 2" id="target2">
        <a-plane
          id="videoPlane2"
          width="1"
          height="1"
          position="0 0.1 0.1"
          material="shader: flat; src: #video3"
          pose-smoother="positionFactor: 0.25; rotationFactor: 0.25; scaleFactor: 0.25"
          visible="false"
        ></a-plane>
      </a-entity>
    </a-scene>

    <!-- Overlays de UI (loading, scanning e instruções) -->
    <div class="video-container">
      <!-- UI de Loading (pode trocar o conteúdo por um GIF) -->
      <div id="ui-loading" class="video-overlay" style="display: none; background: rgba(0,0,0,0.6);">
        <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
          <div style="width:18px; height:18px; border:3px solid #fff; border-top-color: transparent; border-radius:50%; animation: spin 1s linear infinite;"></div>
          <span>Carregando…</span>
        </div>
      </div>

      <!-- UI de Scanning (pode trocar por arte própria) -->
      <div id="ui-scanning" class="video-overlay" style="display: none; background: rgba(0,0,0,0.6);">
        <div style="display:flex; flex-direction:column; align-items:center; gap:8px;">
          <span>Escaneando… aponte a câmera para o marcador</span>
          <div style="width:120px; height:120px; border:2px dashed rgba(255,255,255,0.8); border-radius:8px;"></div>
        </div>
      </div>

      <div class="video-overlay" id="instructions">
        <h3>🎯 MindAR Multi-Targets</h3>
        <p>Apontar a câmera para os targets para ver os vídeos</p>
        <p>Clique na tela para ativar</p>
        <button id="testVideo" style="margin-top: 10px; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
          🎥 Testar Vídeo
        </button>
      </div>
      <div class="target-info" id="targetInfo" style="display: none;">
        <div id="targetStatus">Nenhum target detectado</div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // CSS simples para animação do loading
        const styleSpin = document.createElement('style');
        styleSpin.innerHTML = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(styleSpin);

        // Componente de suavização de pose para reduzir tremor
        if (!AFRAME.components['pose-smoother']) {
          AFRAME.registerComponent('pose-smoother', {
            schema: {
              positionFactor: { type: 'number', default: 0.2 },
              rotationFactor: { type: 'number', default: 0.2 },
              scaleFactor: { type: 'number', default: 0.2 }
            },
            init() {
              this.lastPosition = new THREE.Vector3();
              this.lastQuaternion = new THREE.Quaternion();
              this.lastScale = new THREE.Vector3(1, 1, 1);
              this.hasLast = false;
            },
            tick() {
              const obj = this.el.object3D;
              if (!obj) return;
              if (!this.hasLast) {
                this.lastPosition.copy(obj.position);
                this.lastQuaternion.copy(obj.quaternion);
                this.lastScale.copy(obj.scale);
                this.hasLast = true;
                return;
              }
              // Interpolação linear para posição e escala
              this.lastPosition.lerp(obj.position, this.data.positionFactor);
              this.lastScale.lerp(obj.scale, this.data.scaleFactor);
              // Slerp para rotação
              this.lastQuaternion.slerp(obj.quaternion, this.data.rotationFactor);
              obj.position.copy(this.lastPosition);
              obj.scale.copy(this.lastScale);
              obj.quaternion.copy(this.lastQuaternion);
            }
          });
        }

        // Referências aos elementos
        const videos = [
          document.querySelector("#video1"),
          document.querySelector("#video2"),
          document.querySelector("#video3")
        ];
        
        const videoPlanes = [
          document.querySelector("#videoPlane0"),
          document.querySelector("#videoPlane1"),
          document.querySelector("#videoPlane2")
        ];

        // Ajustar tamanho dos planos conforme o aspect ratio do vídeo
        const applyVideoAspectToPlane = (video, plane) => {
          const setRatio = () => {
            if (!video.videoWidth || !video.videoHeight) return;
            const ratio = video.videoWidth / video.videoHeight;
            // Base: altura = 1 unidade; largura segue o ratio
            const height = 1;
            const width = ratio * height;
            plane.setAttribute('width', width.toFixed(3));
            plane.setAttribute('height', height.toFixed(3));
            console.log(`📐 Plane ${plane.id} ajustado: ${width.toFixed(3)} x ${height.toFixed(3)} (ratio ${ratio.toFixed(3)})`);
          };
          if (video.readyState >= 1) {
            setRatio();
          } else {
            video.addEventListener('loadedmetadata', setRatio, { once: true });
          }
        };
        
        const targets = [
          document.querySelector("#target0"),
          document.querySelector("#target1"),
          document.querySelector("#target2")
        ];

        const instructions = document.querySelector("#instructions");
        const targetInfo = document.querySelector("#targetInfo");
        const targetStatus = document.querySelector("#targetStatus");
        const testVideoBtn = document.querySelector("#testVideo");

        // Função para ativar vídeo
        const enableVideo = (video) => {
          console.log("🎥 Tentando reproduzir vídeo:", video.id);
          try {
            video.setAttribute && video.setAttribute('playsinline', '');
            video.setAttribute && video.setAttribute('webkit-playsinline', '');
          } catch {}
          video.playsInline = true;
          video.muted = true;
          // Se nunca carregou ou houve aborto, força load()
          const mustLoad = video.readyState === 0 || video.networkState === 3; // NETWORK_NO_SOURCE
          if (mustLoad) {
            console.log("📦 Chamando load() no vídeo:", video.id, {readyState: video.readyState, networkState: video.networkState});
            try { video.load(); } catch(e) { console.warn("load() falhou", e); }
          }
          // Tenta tocar
          const tryPlay = () => video.play().then(() => {
            console.log("✅ Vídeo reproduzindo:", video.id, {readyState: video.readyState});
          }).catch((e) => {
            console.warn("❌ Erro ao reproduzir vídeo:", video.id, e);
          });
          if (video.readyState < 2) { // < HAVE_CURRENT_DATA
            const canplayOnce = () => {
              video.removeEventListener('canplay', canplayOnce);
              tryPlay();
            };
            video.addEventListener('canplay', canplayOnce, {once: true});
            // fallback timeout
            setTimeout(tryPlay, 1500);
          } else {
            tryPlay();
          }
        };

        // Função para pausar vídeo
        const pauseVideo = (video) => {
          video.pause();
        };

        // Função para atualizar status
        const updateTargetStatus = (activeTargets) => {
          if (activeTargets.length > 0) {
            targetInfo.style.display = "block";
            targetStatus.textContent = `Targets ativos: ${activeTargets.join(", ")}`;
          } else {
            targetInfo.style.display = "none";
          }
        };

        // Array para rastrear targets ativos
        let activeTargets = [];

        // Primeira interação do usuário
        document.body.addEventListener("click", () => {
          instructions.style.display = "none";
          videos.forEach(video => {
            // Força load antes do play para evitar NS_BINDING_ABORTED
            try { video.load(); } catch {}
            video.muted = true;
            enableVideo(video);
          });
        });
        
        // Botão de teste de vídeo
        testVideoBtn.addEventListener("click", () => {
          console.log("🧪 Testando reprodução de vídeo...");
          const firstVideo = videos[0];
          const firstPlane = videoPlanes[0];
          
          console.log("📺 Forçando visibilidade do plane:", firstPlane.id);
          firstPlane.setAttribute("visible", "true");
          
          console.log("🎥 Forçando reprodução do vídeo:", firstVideo.id);
          enableVideo(firstVideo);
          
          // Mostrar status
          targetInfo.style.display = "block";
          targetStatus.textContent = "Teste de vídeo ativo";
        });

        // Event listeners para cada target
        targets.forEach((target, index) => {
          const video = videos[index];
          const videoPlane = videoPlanes[index];

          // Aplicar proporção do vídeo ao plane
          applyVideoAspectToPlane(video, videoPlane);

          // Quando o target é encontrado
          target.addEventListener("targetFound", () => {
            console.log(`🎯 Target ${index} encontrado`);
            console.log("📺 Ativando vídeo plane:", videoPlane.id);
            videoPlane.setAttribute("visible", "true");
            console.log("🎥 Habilitando vídeo:", video.id);
            // Se ainda não carregou, garante load e play
            if (video.readyState === 0) {
              try { video.load(); } catch {}
            }
            enableVideo(video);
            
            // Adicionar à lista de targets ativos
            if (!activeTargets.includes(index)) {
              activeTargets.push(index);
              updateTargetStatus(activeTargets);
            }
          });

          // Quando o target é perdido
          target.addEventListener("targetLost", () => {
            console.log(`❌ Target ${index} perdido`);
            videoPlane.setAttribute("visible", "false");
            pauseVideo(video);
            
            // Remover da lista de targets ativos
            activeTargets = activeTargets.filter(t => t !== index);
            updateTargetStatus(activeTargets);
          });
        });

        // Controle de visibilidade do overlay
        let hasFoundTarget = false;
        targets.forEach(target => {
          target.addEventListener("targetFound", () => {
            if (!hasFoundTarget) {
              hasFoundTarget = true;
              instructions.style.display = "none";
            }
          });
        });

        // Log de inicialização
        console.log("🚀 MindAR Multi-Targets inicializado");
        console.log("🎯 Targets configurados:", targets.length);
        console.log("🎥 Vídeos configurados:", videos.length);
        console.log("📁 Arquivo .mind:", "./targets/targets(13).mind");
        
        // Verificar se os elementos foram encontrados
        targets.forEach((target, index) => {
          console.log(`Target ${index}:`, target ? "✅ Encontrado" : "❌ Não encontrado");
        });
        
        videos.forEach((video, index) => {
          console.log(`Vídeo ${index}:`, video ? "✅ Encontrado" : "❌ Não encontrado");
          if (video) {
            console.log(`  - src: ${video.src}`);
            console.log(`  - readyState: ${video.readyState}`);
          }
        });
        
        videoPlanes.forEach((plane, index) => {
          console.log(`Plane ${index}:`, plane ? "✅ Encontrado" : "❌ Não encontrado");
        });
        
        // Aguardar o MindAR estar pronto
        const scene = document.querySelector('a-scene');
        scene.addEventListener('renderstart', () => {
          console.log("🎬 MindAR renderizado e pronto!");
        });
        
        // Verificar se há erros no carregamento do .mind
        scene.addEventListener('error', (e) => {
          console.error("❌ Erro no MindAR:", e);
        });
      });
    </script>
  </body>
</html>
