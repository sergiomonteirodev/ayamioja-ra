<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aya mi o j√° - Realidade Aumentada</title>

    <!-- A-Frame e MindAR (mesmas vers√µes do backup que funcionam no Android) -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: transparent;
        position: relative;
      }

      * {
        box-sizing: border-box;
      }

      a-scene {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        height: 100% !important;
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
      }

      /* Garantir que canvas da c√¢mera ocupe 100% */
      a-scene canvas {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
      }

      /* Esconder √≠cones do A-Frame */
      .a-enter-vr-button,
      .a-orientation-modal,
      .a-enter-vr-modal,
      .a-fullscreen-button,
      .a-fullscreen-modal,
      .a-fullscreen-overlay,
      .a-fullscreen-icon,
      [class*="fullscreen"],
      [class*="vr-button"],
      [class*="orientation"] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }

      .video-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
      }

      .video-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        font-family: Arial, sans-serif;
        max-width: 300px;
      }

      /* Modal de Scanning Personalizado */
      .scanning-overlay {
        background: linear-gradient(135deg, rgba(226, 106, 2, 0.9), rgba(91, 44, 9, 0.9));
        backdrop-filter: blur(10px);
      }

      .scanning-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 40px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        max-width: 400px;
        text-align: center;
      }

      .scanning-icon {
        position: relative;
      }

      .scanning-circle {
        width: 80px;
        height: 80px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        position: relative;
        animation: pulse 2s ease-in-out infinite;
      }

      .scanning-dot {
        width: 12px;
        height: 12px;
        background: #e26a02;
        border-radius: 50%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: scan 1.5s linear infinite;
      }

      .scanning-title {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
        color: white;
      }

      .scanning-text {
        font-size: 16px;
        margin: 0;
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.4;
      }

      .scanning-progress {
        width: 200px;
        height: 4px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
        overflow: hidden;
      }

      .progress-bar {
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        position: relative;
      }

      .progress-fill {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, #e26a02, #ff8c42);
        border-radius: 2px;
        animation: progress 3s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% {
          transform: scale(1);
          opacity: 1;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      @keyframes scan {
        0% {
          transform: translate(-50%, -50%) rotate(0deg) translateX(30px) rotate(0deg);
        }
        100% {
          transform: translate(-50%, -50%) rotate(360deg) translateX(30px) rotate(-360deg);
        }
      }

      @keyframes progress {
        0% {
          width: 0%;
        }
        50% {
          width: 70%;
        }
        100% {
          width: 100%;
        }
      }

      .target-info {
        position: absolute;
        top: 20px;
        left: 20px;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px;
        border-radius: 5px;
        font-family: Arial, sans-serif;
        font-size: 14px;
      }

      /* Toggle Controls - mesmo estilo do app React */
      .toggle-controls {
        position: absolute;
        top: 120px;
        left: 0;
        right: 0;
        z-index: 999;
        display: flex;
        justify-content: space-between;
        padding: 0 30px;
      }

      .toggle-label {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: rgb(255, 255, 255);
        padding: 8px 15px;
        border-radius: 25px;
        color: #e26a02;
        font-weight: 600;
        cursor: pointer;
        font-family: 'RooneySans', Arial, sans-serif;
      }

      .toggle-input {
        display: none !important;
      }

      .toggle-slider {
        width: 50px;
        height: 24px;
        background-color: #ccc;
        border-radius: 12px;
        position: relative;
        transition: background-color 0.3s;
      }

      .toggle-slider::before {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: white;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }

      .toggle-input:checked + .toggle-slider {
        background-color: #5b2c09;
      }

      .toggle-input:checked + .toggle-slider::before {
        transform: translateX(26px);
      }

      .toggle-text {
        font-size: 25px;
      }

      .toggle-icon {
        width: 45px;
        height: 45px;
        object-fit: contain;
      }

      /* Bot√£o Voltar */
      .back-button-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        margin: 0;
        padding: 0;
        pointer-events: auto;
      }

      .back-button {
        display: block;
        text-decoration: none;
        color: inherit;
        margin: 0;
        padding: 0;
        line-height: 0;
      }

      .back-button-image {
        width: 150px;
        height: 150px;
        object-fit: contain;
        transition: all 0.3s ease;
        cursor: pointer;
        display: block;
        margin: 0;
        padding: 0;
        border: none;
        background: transparent;
      }

      .back-button-image:hover {
        transform: scale(1.1);
      }

      /* Responsividade b√°sica (mantida do backup) */
      @media (max-width: 768px) {
        .toggle-controls {
          top: 90px;
          padding: 0 10px;
        }

        .toggle-label {
          font-size: 10px;
          padding: 4px 8px;
          gap: 6px;
        }

        .toggle-slider {
          width: 35px;
          height: 18px;
        }

        .toggle-slider::before {
          width: 14px;
          height: 14px;
        }

        .toggle-input:checked + .toggle-slider::before {
          transform: translateX(17px);
        }

        .toggle-text {
          font-size: 14px;
        }

        .toggle-icon {
          width: 30px;
          height: 30px;
        }

        .back-button-image {
          width: 100px;
          height: 100px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toggle Controls -->
    <div class="toggle-controls">
      <div class="toggle-left">
        <label class="toggle-label">
          <img src="../images/libras.png" alt="Libras" class="toggle-icon" />
          <input type="checkbox" id="libras-toggle" class="toggle-input" />
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="toggle-right">
        <label class="toggle-label">
          <input type="checkbox" id="audio-toggle" class="toggle-input" />
          <span class="toggle-slider"></span>
          <img src="../images/ad.png" alt="√Åudio descri√ß√£o" class="toggle-icon" />
        </label>
      </div>
    </div>

    <!-- Bot√£o Voltar -->
    <div class="back-button-container">
      <a href="../index.html" class="back-button">
        <img src="../images/voltar_botao.png" alt="Voltar" class="back-button-image" />
      </a>
    </div>

    <a-scene
      mindar-image="imageTargetSrc: ../ar-assets/targets/targets(13).mind; maxTrack: 3; uiScanning: #ui-scanning; uiLoading: #ui-loading; filterMinCF: 0.0001; filterBeta: 0.1; missTolerance: 15; warmupTolerance: 3; autoStart: true; showStats: false;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights: true, antialias: false, precision: mediump"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
      ui="enabled: false"
    >
      <a-assets>
        <!-- V√≠deo para Target 0 - anim_4.mp4 -->
        <video
          id="video1"
          src="../ar-assets/assets/anim_4.mp4"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
        ></video>

        <!-- V√≠deo para Target 1 - anim_3.mp4 -->
        <video
          id="video2"
          src="../ar-assets/assets/anim_3.mp4"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
        ></video>

        <!-- V√≠deo para Target 2 - anim_2.mp4 -->
        <video
          id="video3"
          src="../ar-assets/assets/anim_2.mp4"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Target 0 - Primeiro v√≠deo -->
      <a-entity mindar-image-target="targetIndex: 0" id="target0">
        <a-plane
          id="videoPlane0"
          width="1"
          height="1"
          position="0 0.1 0.1"
          material="shader: flat; src: #video1"
          visible="false"
        ></a-plane>
      </a-entity>

      <!-- Target 1 - Segundo v√≠deo -->
      <a-entity mindar-image-target="targetIndex: 1" id="target1">
        <a-plane
          id="videoPlane1"
          width="1"
          height="1"
          position="0 0.1 0.1"
          material="shader: flat; src: #video2"
          visible="false"
        ></a-plane>
      </a-entity>

      <!-- Target 2 - Terceiro v√≠deo -->
      <a-entity mindar-image-target="targetIndex: 2" id="target2">
        <a-plane
          id="videoPlane2"
          width="1"
          height="1"
          position="0 0 0.005"
          material="shader: flat; src: #video3"
          visible="false"
        ></a-plane>
      </a-entity>
    </a-scene>

    <!-- Overlays de UI (loading, scanning e instru√ß√µes) -->
    <div class="video-container">
      <div id="ui-loading" class="video-overlay" style="display: none; background: rgba(0,0,0,0.6);">
        <div style="display:flex; align-items:center; gap:10px; justify-content:center;">
          <div style="width:18px; height:18px; border:3px solid #fff; border-top-color: transparent; border-radius:50%; animation: spin 1s linear infinite;"></div>
          <span>Carregando‚Ä¶</span>
        </div>
      </div>

      <div id="ui-scanning" class="video-overlay scanning-overlay" style="display: none;">
        <div class="scanning-content">
          <div class="scanning-icon">
            <div class="scanning-circle">
              <div class="scanning-dot"></div>
            </div>
          </div>
          <h3 class="scanning-title">Escaneando Target</h3>
          <p class="scanning-text">Aponte a c√¢mera para o marcador para ativar o v√≠deo</p>
          <div class="scanning-progress">
            <div class="progress-bar">
              <div class="progress-fill"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="video-overlay instructions-overlay" id="instructions">
        <div class="instructions-content">
          <div class="instructions-icon">
            <div class="target-icon">üéØ</div>
          </div>
          <h3 class="instructions-title">AY√Ä MI O J√Å</h3>
          <p class="instructions-text">Aponte a c√¢mera para os targets para ver os v√≠deos</p>
          <p class="instructions-subtext">Toque na tela para ativar</p>
        </div>
      </div>

      <div class="target-info" id="targetInfo" style="display: none;">
        <div id="targetStatus">Nenhum target detectado</div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const styleSpin = document.createElement('style');
        styleSpin.innerHTML = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(styleSpin);

        const videos = [
          document.querySelector('#video1'),
          document.querySelector('#video2'),
          document.querySelector('#video3')
        ];

        const videoPlanes = [
          document.querySelector('#videoPlane0'),
          document.querySelector('#videoPlane1'),
          document.querySelector('#videoPlane2')
        ];

        const targets = [
          document.querySelector('#target0'),
          document.querySelector('#target1'),
          document.querySelector('#target2')
        ];

        const instructions = document.querySelector('#instructions');
        const targetInfo = document.querySelector('#targetInfo');
        const targetStatus = document.querySelector('#targetStatus');

        const isAndroid = /Android/i.test(navigator.userAgent);

        // Pr√©-carregar v√≠deos
        const preloadVideos = () => {
          videos.forEach((video) => {
            if (!video) return;
            video.setAttribute('playsinline', '');
            video.setAttribute('webkit-playsinline', '');
            video.playsInline = true;
            if (video.readyState === 0) {
              try {
                video.load();
              } catch (e) {
                console.warn('Erro ao pr√©-carregar v√≠deo', video.id, e);
              }
            }
          });
        };

        const enableVideo = (video, retryCount = 0) => {
          if (!video) return;
          video.setAttribute('playsinline', '');
          video.setAttribute('webkit-playsinline', '');
          video.playsInline = true;

          const tryPlay = () =>
            video.play().catch((e) => {
              if (isAndroid && retryCount < 3) {
                setTimeout(() => enableVideo(video, retryCount + 1), 500);
              } else {
                console.warn('Erro ao reproduzir v√≠deo', video.id, e);
              }
            });

          if (video.readyState < 2) {
            const once = () => {
              video.removeEventListener('canplay', once);
              tryPlay();
            };
            video.addEventListener('canplay', once, { once: true });
            setTimeout(tryPlay, isAndroid ? 2500 : 1500);
          } else {
            tryPlay();
          }
        };

        const pauseVideo = (video) => {
          if (video) video.pause();
        };

        let activeTargets = [];

        const updateTargetStatus = (list) => {
          if (list.length > 0) {
            targetInfo.style.display = 'block';
            targetStatus.textContent = `Targets ativos: ${list.join(', ')}`;
          } else {
            targetInfo.style.display = 'none';
          }
        };

        console.log('üöÄ Iniciando pr√©-carregamento de v√≠deos...');
        preloadVideos();

        let userInteracted = false;
        document.body.addEventListener(
          'click',
          () => {
            if (userInteracted) return;
            userInteracted = true;
            instructions.style.display = 'none';
            videos.forEach((video) => enableVideo(video));
          },
          { once: true }
        );

        targets.forEach((target, index) => {
          const video = videos[index];
          const plane = videoPlanes[index];

          target.addEventListener('targetFound', () => {
            console.log('üéØ Target encontrado', index);
            enableVideo(video);
            const reveal = () => {
              plane.setAttribute('visible', 'true');
            };
            if (video.readyState >= 2) {
              reveal();
            } else {
              const once = () => {
                video.removeEventListener('canplay', once);
                reveal();
              };
              video.addEventListener('canplay', once);
            }

            if (!activeTargets.includes(index)) {
              activeTargets.push(index);
              updateTargetStatus(activeTargets);
            }
          });

          target.addEventListener('targetLost', () => {
            console.log('‚ùå Target perdido', index);
            plane.setAttribute('visible', 'false');
            pauseVideo(video);
            activeTargets = activeTargets.filter((t) => t !== index);
            updateTargetStatus(activeTargets);
          });
        });

        // √Åudio descri√ß√£o simples mapeado por target (mesmo mapeamento do app React)
        const audioToggle = document.getElementById('audio-toggle');
        const adAudio = new Audio();
        adAudio.preload = 'auto';
        adAudio.loop = false;

        const getAdSrcForTarget = (index) => {
          if (index === 0) return '../ar-assets/assets/ads/ad_anim_4.m4a';
          if (index === 1) return '../ar-assets/assets/ads/ad_anim_3.m4a';
          if (index === 2) return '../ar-assets/assets/ads/ad_anim_2.m4a';
          return null;
        };

        const getMainVideoForTarget = (index) => videos[index] || null;

        let currentAdTarget = null;

        const syncAdWithVideo = () => {
          if (currentAdTarget == null) return;
          const video = getMainVideoForTarget(currentAdTarget);
          if (!video) return;
          if (!video.paused) {
            adAudio.currentTime = video.currentTime;
          }
        };

        audioToggle.addEventListener('change', () => {
          if (!audioToggle.checked) {
            adAudio.pause();
            return;
          }

          if (activeTargets.length === 0) {
            audioToggle.checked = false;
            return;
          }

          currentAdTarget = activeTargets[activeTargets.length - 1];
          const src = getAdSrcForTarget(currentAdTarget);
          if (!src) return;

          adAudio.src = src;
          syncAdWithVideo();
          adAudio.volume = 1.0;
          adAudio
            .play()
            .then(() => {
              console.log('‚ñ∂Ô∏è √Åudio descri√ß√£o AR reproduzindo para target', currentAdTarget);
            })
            .catch((e) => {
              console.warn('Erro ao reproduzir √°udio descri√ß√£o AR:', e);
              audioToggle.checked = false;
            });
        });

        videos.forEach((video, index) => {
          if (!video) return;
          video.addEventListener('timeupdate', () => {
            if (audioToggle.checked && currentAdTarget === index && !video.paused) {
              syncAdWithVideo();
            }
          });

          video.addEventListener('pause', () => {
            if (currentAdTarget === index) {
              adAudio.pause();
            }
          });
        });
      });
    </script>
  </body>
</html>

