<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        html, body {
          margin: 0;
          padding: 0;
          height: 100%;
          overflow: hidden;
          background: transparent;
        }
        a-scene {
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
        }
        .video-container {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1000;
        }
        .video-overlay {
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
          font-family: Arial, sans-serif;
          max-width: 300px;
        }
        .target-info {
          position: absolute;
          top: 20px;
          left: 20px;
          background: rgba(0, 0, 0, 0.7);
          color: white;
          padding: 10px;
          border-radius: 5px;
          font-family: Arial, sans-serif;
          font-size: 14px;
        }
    </style>
  </head>
  <body>
    <a-scene
      mindar-image="imageTargetSrc: ./targets/targets(3).mind; maxTrack: 3; uiScanning: #instructions; uiLoading: #instructions;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights: true"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true"
      embedded
    >
      <a-assets>
        <!-- V√≠deo para Target 0 -->
        <video
          id="video1"
          src="assets/ayo_teste.mp4"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
          muted
        ></video>
        
        <!-- V√≠deo para Target 1 (mesmo v√≠deo por enquanto) -->
        <video
          id="video2"
          src="assets/ayo_teste.mp4"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
          muted
        ></video>
        
        <!-- V√≠deo para Target 2 (mesmo v√≠deo por enquanto) -->
        <video
          id="video3"
          src="assets/ayo_teste.mp4"
          preload="auto"
          loop
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
          muted
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Target 0 - Primeiro v√≠deo -->
      <a-entity mindar-image-target="targetIndex: 0" id="target0">
        <a-plane
          id="videoPlane0"
          width="1"
          height="1"
          position="0 0.1 0.1"
          material="shader: flat; src: #video1"
          visible="false"
        ></a-plane>
      </a-entity>

      <!-- Target 1 - Segundo v√≠deo -->
      <a-entity mindar-image-target="targetIndex: 1" id="target1">
        <a-plane
          id="videoPlane1"
          width="1"
          height="1"
          position="0 0.1 0.1"
          material="shader: flat; src: #video2"
          visible="false"
        ></a-plane>
      </a-entity>

      <!-- Target 2 - Terceiro v√≠deo -->
      <a-entity mindar-image-target="targetIndex: 2" id="target2">
        <a-plane
          id="videoPlane2"
          width="1"
          height="1"
          position="0 0.1 0.1"
          material="shader: flat; src: #video3"
          visible="false"
        ></a-plane>
      </a-entity>
    </a-scene>

    <!-- Overlay de instru√ß√µes -->
    <div class="video-container">
      <div class="video-overlay" id="instructions">
        <h3>üéØ MindAR Multi-Targets</h3>
        <p>Apontar a c√¢mera para os targets para ver os v√≠deos</p>
        <p>Clique na tela para ativar</p>
        <button id="testVideo" style="margin-top: 10px; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
          üé• Testar V√≠deo
        </button>
      </div>
      <div class="target-info" id="targetInfo" style="display: none;">
        <div id="targetStatus">Nenhum target detectado</div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // Refer√™ncias aos elementos
        const videos = [
          document.querySelector("#video1"),
          document.querySelector("#video2"),
          document.querySelector("#video3")
        ];
        
        const videoPlanes = [
          document.querySelector("#videoPlane0"),
          document.querySelector("#videoPlane1"),
          document.querySelector("#videoPlane2")
        ];
        
        const targets = [
          document.querySelector("#target0"),
          document.querySelector("#target1"),
          document.querySelector("#target2")
        ];

        const instructions = document.querySelector("#instructions");
        const targetInfo = document.querySelector("#targetInfo");
        const targetStatus = document.querySelector("#targetStatus");
        const testVideoBtn = document.querySelector("#testVideo");

        // Fun√ß√£o para ativar v√≠deo
        const enableVideo = (video) => {
          console.log("üé• Tentando reproduzir v√≠deo:", video.id);
          try {
            video.setAttribute && video.setAttribute('playsinline', '');
            video.setAttribute && video.setAttribute('webkit-playsinline', '');
          } catch {}
          video.playsInline = true;
          video.muted = true;
          // Se nunca carregou ou houve aborto, for√ßa load()
          const mustLoad = video.readyState === 0 || video.networkState === 3; // NETWORK_NO_SOURCE
          if (mustLoad) {
            console.log("üì¶ Chamando load() no v√≠deo:", video.id, {readyState: video.readyState, networkState: video.networkState});
            try { video.load(); } catch(e) { console.warn("load() falhou", e); }
          }
          // Tenta tocar
          const tryPlay = () => video.play().then(() => {
            console.log("‚úÖ V√≠deo reproduzindo:", video.id, {readyState: video.readyState});
          }).catch((e) => {
            console.warn("‚ùå Erro ao reproduzir v√≠deo:", video.id, e);
          });
          if (video.readyState < 2) { // < HAVE_CURRENT_DATA
            const canplayOnce = () => {
              video.removeEventListener('canplay', canplayOnce);
              tryPlay();
            };
            video.addEventListener('canplay', canplayOnce, {once: true});
            // fallback timeout
            setTimeout(tryPlay, 1500);
          } else {
            tryPlay();
          }
        };

        // Fun√ß√£o para pausar v√≠deo
        const pauseVideo = (video) => {
          video.pause();
        };

        // Fun√ß√£o para atualizar status
        const updateTargetStatus = (activeTargets) => {
          if (activeTargets.length > 0) {
            targetInfo.style.display = "block";
            targetStatus.textContent = `Targets ativos: ${activeTargets.join(", ")}`;
          } else {
            targetInfo.style.display = "none";
          }
        };

        // Array para rastrear targets ativos
        let activeTargets = [];

        // Primeira intera√ß√£o do usu√°rio
        document.body.addEventListener("click", () => {
          instructions.style.display = "none";
          videos.forEach(video => {
            // For√ßa load antes do play para evitar NS_BINDING_ABORTED
            try { video.load(); } catch {}
            video.muted = true;
            enableVideo(video);
          });
        });
        
        // Bot√£o de teste de v√≠deo
        testVideoBtn.addEventListener("click", () => {
          console.log("üß™ Testando reprodu√ß√£o de v√≠deo...");
          const firstVideo = videos[0];
          const firstPlane = videoPlanes[0];
          
          console.log("üì∫ For√ßando visibilidade do plane:", firstPlane.id);
          firstPlane.setAttribute("visible", "true");
          
          console.log("üé• For√ßando reprodu√ß√£o do v√≠deo:", firstVideo.id);
          enableVideo(firstVideo);
          
          // Mostrar status
          targetInfo.style.display = "block";
          targetStatus.textContent = "Teste de v√≠deo ativo";
        });

        // Event listeners para cada target
        targets.forEach((target, index) => {
          const video = videos[index];
          const videoPlane = videoPlanes[index];

          // Quando o target √© encontrado
          target.addEventListener("targetFound", () => {
            console.log(`üéØ Target ${index} encontrado`);
            console.log("üì∫ Ativando v√≠deo plane:", videoPlane.id);
            videoPlane.setAttribute("visible", "true");
            console.log("üé• Habilitando v√≠deo:", video.id);
            // Se ainda n√£o carregou, garante load e play
            if (video.readyState === 0) {
              try { video.load(); } catch {}
            }
            enableVideo(video);
            
            // Adicionar √† lista de targets ativos
            if (!activeTargets.includes(index)) {
              activeTargets.push(index);
              updateTargetStatus(activeTargets);
            }
          });

          // Quando o target √© perdido
          target.addEventListener("targetLost", () => {
            console.log(`‚ùå Target ${index} perdido`);
            videoPlane.setAttribute("visible", "false");
            pauseVideo(video);
            
            // Remover da lista de targets ativos
            activeTargets = activeTargets.filter(t => t !== index);
            updateTargetStatus(activeTargets);
          });
        });

        // Controle de visibilidade do overlay
        let hasFoundTarget = false;
        targets.forEach(target => {
          target.addEventListener("targetFound", () => {
            if (!hasFoundTarget) {
              hasFoundTarget = true;
              instructions.style.display = "none";
            }
          });
        });

        // Log de inicializa√ß√£o
        console.log("üöÄ MindAR Multi-Targets inicializado");
        console.log("üéØ Targets configurados:", targets.length);
        console.log("üé• V√≠deos configurados:", videos.length);
        console.log("üìÅ Arquivo .mind:", "./targets/targets(3).mind");
        
        // Verificar se os elementos foram encontrados
        targets.forEach((target, index) => {
          console.log(`Target ${index}:`, target ? "‚úÖ Encontrado" : "‚ùå N√£o encontrado");
        });
        
        videos.forEach((video, index) => {
          console.log(`V√≠deo ${index}:`, video ? "‚úÖ Encontrado" : "‚ùå N√£o encontrado");
          if (video) {
            console.log(`  - src: ${video.src}`);
            console.log(`  - readyState: ${video.readyState}`);
          }
        });
        
        videoPlanes.forEach((plane, index) => {
          console.log(`Plane ${index}:`, plane ? "‚úÖ Encontrado" : "‚ùå N√£o encontrado");
        });
        
        // Aguardar o MindAR estar pronto
        const scene = document.querySelector('a-scene');
        scene.addEventListener('renderstart', () => {
          console.log("üé¨ MindAR renderizado e pronto!");
        });
        
        // Verificar se h√° erros no carregamento do .mind
        scene.addEventListener('error', (e) => {
          console.error("‚ùå Erro no MindAR:", e);
        });
      });
    </script>
  </body>
</html>
